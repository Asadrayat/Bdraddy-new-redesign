{% assign product = all_products[section.settings.product] %}
{% liquid
  assign id = section.id

  for option in product.options_with_values
    if option.name == 'Color' or option.name == 'color' or option.name == 'COLOR'
      assign color_option = 'option' | append: option.position
    endif
  endfor
  assign selected_color = product.selected_or_first_available_variant[color_option] | downcase
  assign is_selected_variant = product.selected_or_first_available_variant.id

  assign is_alt_text = false
  for media in product.media
    assign alt_txt = media.alt | split: '#' | first | strip | downcase
    if alt_txt == selected_color
      assign is_alt_text = true
    endif
  endfor
%}

<style>
      .section--{{ section.id }} {
        box-sizing: border-box;
        margin-top: {{section.settings.margin_top | append: 'px'}};
        margin-bottom: {{section.settings.margin_bottom | append: 'px'}};
        padding-top: {{section.settings.padding_top | append: 'px'}};
        padding-bottom: {{section.settings.padding_bottom | append: 'px'}};
        {% if product == blank %}
          display: none;
        {% endif %}
      }

      @media(max-width: 1249px) {
        .section--{{ section.id }} {
          margin-top: {{section.settings.margin_top_m | append: 'px'}};
          margin-bottom: {{section.settings.margin_bottom_m | append: 'px'}};
          padding-top: {{section.settings.padding_top_m | append: 'px'}};
          padding-bottom: {{section.settings.padding_bottom_m | append: 'px'}};
        }
      }

    .section--{{ section.id }} {
      a.--shop-the-look-anchor {
        display: none;
      }
    .pdp__frame_image {
        display: none;
    }
    accordion-element,.--custom-style {
    display: none;
}
.mb, .--custom-style {
    margin: 0;
}
.lg-view.pinfo-breadcrumb.mb {
 margin-bottom: 24px;
}

{% comment %} Quick add styles {% endcomment %}
 .pqa-new-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--Spacing-Container-md);
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #e7e9eb;
    box-shadow: 0 0 #0000, 0 0 #0000, 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);
}
 .pqa-new-variants {
    display: none;
}



    @media screen and (max-width: 768px) {
        .pdp-media-sm .swiper-slide img, .pdp-media-sm .swiper-slide video {

            background-image: unset;
            background-size: unset;
            content-visibility: auto;
            box-sizing: border-box;
            padding: unset;
        }
    }
    product-info-content {
      gap: 16px;
      z-index: 1;
  }
  .pinfo-top {
    gap: 8px;
    margin-bottom: 16px;
}
  
  }
      @media (min-width: 1200px) {
          product-info-media {
              position: sticky;
              top: 0;
              {% comment %} height: max-content; {% endcomment %}
              height: 100%;
              max-height: 100vh;
              overflow: scroll;
              scrollbar-width: none;
          }
          .info-media-stack-wrapper {

          }
          picture.pinfo-stack-picture{
            position: unset;
            width: unset;
            height: unset;
          }
      }

    }
</style>
<div
  id="product-information-container"
  data-id="{{ section.id }}"
  class="section--{{ section.id }} landing--featured--product"
>

</div>
{% render 'size-guide-popup', product: product %}
<script>
const renderProductSection = () => {
  // Select the target section
  const landingProductSection = document.querySelector(".section--{{ section.id }}.landing--featured--product");
  if (!landingProductSection) {
    console.error("Error: Landing product section not found");
    return;
  }

  // Validate product URL
  const productUrl = "{{ product.url }}"; // Ensure this is properly rendered by Liquid
  if (!productUrl || typeof productUrl !== "string" || !productUrl.trim()) {
    console.error("Error: Invalid or missing product URL");
    return;
  }

  // Prevent multiple simultaneous requests
  if (document.body.classList.contains("adding-to-cart")) {
    console.warn("Operation skipped: Already adding to cart");
    return;
  }

  // Add loading state
  {% comment %} document.body.classList.add("adding-to-cart"); {% endcomment %}

  // Fetch product data
  fetch(productUrl)
    .then((res) => {
      if (!res.ok) {
        throw new Error(`HTTP error! Status: ${res.status}`);
      }
      return res.text();
    })
    .then((res) => {
      const wholehtml = new DOMParser().parseFromString(res, "text/html");
      const html = wholehtml.querySelector("#--custom-product-section");
      if (!html) {
        console.log('productUrl',productUrl)
        console.log('wholehtml',wholehtml)
        console.error("Error: #--product-section not found in response");
        return;
      }

      // Cache selectors for performance
      const bundleWrapper = html.querySelector(".pinfo-bundle-wrapper");
      const faqWrapper = html.querySelector(".product-faq-wrapper");
      const mediaLg = window.innerWidth < 600 ? html.querySelector(".pdp-media-lg") : null;
      const productInfo = html.querySelector("product-information");
      const productInfoContainer = html.querySelector("#product-information-container");

      // Remove unnecessary elements
      if (bundleWrapper) bundleWrapper.remove();
      if (faqWrapper) faqWrapper.remove();
      if (mediaLg) mediaLg.remove();
      if (productInfo) productInfo.setAttribute("data-update-url", "false");

      {% comment %} // Validate content container
      const pqvContent = landingProductSection.querySelector(".pqv-content");
      if (!pqvContent || !productInfoContainer) {
        console.error("Error: .pqv-content or #product-information-container not found");
        return;
      } {% endcomment %}

      // Render content
      landingProductSection.innerHTML = productInfoContainer.innerHTML;
    // Call additional functions if defined
      if (typeof window.sizeGuide === "function") {
        window.sizeGuide();
      } else {
        console.warn("Size guide is not defined");
      }
      // Call additional functions if defined
      if (typeof window.viewerCountPastDay === "function") {
        window.viewerCountPastDay();
      } else {
        console.warn("viewerCountPastDay is not defined");
      }
      
    })
    .catch((err) => {
      console.error("Fetch error:", err);
    })
    .finally(() => {
      {% comment %} document.body.classList.remove("adding-to-cart"); {% endcomment %}
       window.enableStickyATC();
    });
};

// Run when DOM is loaded
document.addEventListener("DOMContentLoaded", renderProductSection);

</script>

{% schema %}
{
  "name": "LP Featured Product v2",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Select Product"
    },

    {
      "type": "select",
      "id": "image_style",
      "label": "Product Media",
      "options": [
        {
          "value": "stack",
          "label": "Stack"
        }
      ],
      "default": "stack"
    },

    {
      "type": "checkbox",
      "id": "lightbox",
      "label": "Enable Lightbox",
      "default": true
    },
    {
      "type": "header",
      "content": "Section Spacing Desktop"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding Top",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 48
    },
    {
      "type": "header",
      "content": "Section Spacing Mobile"
    },
    {
      "type": "range",
      "id": "margin_top_m",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom_m",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_top_m",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding Top",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom_m",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 32
    }
  ],

  "presets": [
    {
      "name": "LP Featured Product v2"
    }
  ]
}
{% endschema %}
