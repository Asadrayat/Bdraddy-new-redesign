<style>
    .main-product-logo--custom {
    .info-media-stack-wrapper:not(.pqv-container .info-media-stack-wrapper) .info-media-image:nth-child(1) {
        grid-column: 1 / -1;
    }
  }
  .front-swatch,
  .back-swatch,
  .button-group--left-sleeve--custom,
  .button-group--right-sleeve--custom,
  .button-group--right-back-shoulder--custom,
  .button-group--on-pocket-right-side--custom,
  .button-group--bottom-hem--custom {
    border: 2px solid transparent;
    padding: 2px;
    margin: 2px;
    cursor: pointer;
    background: none;
    width: 80px;
    height: 80px;
  }
  .front-swatch img,
  .back-swatch img,
  .button-group--left-sleeve--custom img,
  .button-group--right-sleeve--custom img,
  .button-group--right-back-shoulder--custom img,
  .button-group--on-pocket-right-side--custom img,
  .button-group--bottom-hem--custom img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    aspect-ratio: 1;
  }
  .front-swatch.active,
  .back-swatch.active,
  .button-group--left-sleeve--custom.active,
  .button-group--right-sleeve--custom.active,
  .button-group--right-back-shoulder--custom.active,
  .button-group--on-pocket-right-side--custom.active,
  .button-group--bottom-hem--custom.active {
    border-color: #000;
  }
  .back-swatches-group,
  .left-sleeve-button-group-wrapper,
  .right-sleeve-button-group-wrapper,
  .right-back-shoulder-button-group-wrapper,
  .on-pocket-right-side-button-group-wrapper,
  .bottom-hem-button-group-wrapper {
    display: none;
    flex-wrap: wrap;
    gap: 5px;
  }
.front-swatches {
    display: flex;
}
  .back-swatches-group.active,
  .left-sleeve-button-group-wrapper.active,
  .right-sleeve-button-group-wrapper.active,
  .right-back-shoulder-button-group-wrapper.active,
  .on-pocket-right-side-button-group-wrapper.active,
  .bottom-hem-button-group-wrapper.active {
    display: flex;
  }
  .left-sleeve-designs,
  .right-sleeve-designs,
  .right-back-shoulder-designs,
  .on-pocket-right-side-designs,
  .bottom-hem-designs {
    display: none;
  }
  .left-sleeve-designs.active,
  .right-sleeve-designs.active,
  .right-back-shoulder-designs.active,
  .on-pocket-right-side-designs.active,
  .bottom-hem-designs.active {
    display: block;
  }
  /* Ensure only the first .pdp-media is visible in desktop stack */
  .info-media-stack-wrapper .pdp-media {
    display: none;
  }
  .info-media-stack-wrapper .pdp-media:first-child {
    display: block;
  }
  .ryder-container--custom{
    color: var(--Content-Base-main, #1F2937);
    font-family: var(--font-family-Title, Gotham);
    font-size: var(--Font-Size-Paragraph-Medium, 14px);
    font-style: normal;
    font-weight: 700;
    line-height: var(--Line-Height-Paragraph-Medium, 22px);
    text-transform: uppercase;
    margin: 0 0 12px;
  }
  .linked-product-container--custom{
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: left;
    p{
      color: #4B5563;
      font-size: 14px;
      line-height: 22px;
      transition: all 0.3s;
      text-transform: uppercase;
      margin: 0;
    }
  }
  .ryder-cup--custom--blocks{
    margin-block: 16px;
  }

.back-designs-wrapper.active {
  display: block !important;
}
.back-designs-wrapper .back-swatches-group {
  display: none;
  flex-wrap: wrap;
  gap: 5px;
}
.back-designs-wrapper .back-swatches-group.active {
  display: flex;
}
</style>

{% assign ryder_cup_link_products = product.metafields.custom.ryder_cup_linked_products.value %}
<div class="ryder-cup--custom--blocks">
    <div class="ryder-container--custom">Color: {{ product.title | split: '|' | last }}</div>
    <div class="linked-product-container--custom">
    {% if ryder_cup_link_products %}
        {% for product in ryder_cup_link_products %}
        <div class="linked-product-wrapper--custom">
            <a class="linked-product-link--custom" href="{{ product.url }}">
            {% if product.featured_image %}
                {{
                product.featured_image
                | image_url: width: 60
                | image_tag: class: 'linked-product-featured-img--custom'
                }}
            {% endif %}
            </a>
        </div>
        {% endfor %}
    {% endif %}
    </div>
</div>

{% assign ryder_cup = product.metafields.custom.ryder_cup.value %}
{% assign first_group = ryder_cup | first %}
{% assign has_left_sleeve = false %}
{% assign has_right_sleeve = false %}
{% assign has_back = false %}
{% assign has_right_back_shoulder = false %}
{% assign has_on_pocket_right_side = false %}
{% assign has_bottom_hem = false %}
{% for group in ryder_cup %}
  {% if group.left_sleeve %}{% assign has_left_sleeve = true %}{% endif %}
  {% if group.right_sleeve %}{% assign has_right_sleeve = true %}{% endif %}
  {% if group.back_image_for_swatch %}{% assign has_back = true %}{% endif %}
  {% if group.right_back_shoulder %}{% assign has_right_back_shoulder = true %}{% endif %}
  {% if group.on_pocket_right_side %}{% assign has_on_pocket_right_side = true %}{% endif %}
  {% if group.bottom_hem %}{% assign has_bottom_hem = true %}{% endif %}
{% endfor %}

<div class="ryder-cup-selector">
  <!-- FRONT DESIGN SWATCHES -->
  {% for entry in ryder_cup %}
    {% if forloop.first %}
    {% comment %} {% assign front_swatch_name = entry.front_image | image_url | split: 'files/' | last | split: '.' | first %} {% endcomment %}
      {% assign front_swatch_name = entry.front_logo_placement %}
    {% endif %}
  {% endfor %}


  <div class="front-designs ryder-cup--custom--blocks {{ front_swatch_name }} {% if front_swatch_name == 'none' %}hidden{% endif %}">
    <p class="ryder-container--custom">Front Design</p>
    <div class="front-swatches">
      {% for group in ryder_cup %}
        <button
          class="front-swatch {% if forloop.first %}active{% endif %}"
          data-group-index="{{ forloop.index0 }}"
          data-front-image="{{ group.front_image | image_url }}"
          data-front-logo-placement="{{ group.front_logo_placement }}"
          data-has-left-sleeve="{% if group.left_sleeve %}true{% else %}false{% endif %}"
          data-has-right-sleeve="{% if group.right_sleeve %}true{% else %}false{% endif %}"
          data-has-right-back-shoulder="{% if group.right_back_shoulder %}true{% else %}false{% endif %}"
          data-has-on-pocket-right-side="{% if group.on_pocket_right_side %}true{% else %}false{% endif %}"
          data-has-bottom-hem="{% if group.bottom_hem %}true{% else %}false{% endif %}"
        >
          <img src="{{ group.front_image_for_swatch | img_url: '100x100' }}" alt="Front Swatch {{ forloop.index }}">
        </button>
      {% endfor %}
    </div>
  </div>

  <!-- BACK DESIGN SWATCHES -->
  {% if has_back %}
<div class="back-designs-wrapper ryder-cup--custom--blocks" style="display: none;">
  <p class="ryder-container--custom">Back Design</p>
  <div class="back-swatches-container">
    {% for group in ryder_cup %}
      <div class="back-swatches-group {% if forloop.first %}active{% endif %}" 
           data-group-index="{{ forloop.index0 }}"
           style="{% unless group.back_image_for_swatch.value and group.back_image_for_swatch.value.size > 0 %}display: none;{% endunless %}">
        {% for back_swatch in group.back_image_for_swatch.value %}
          {% assign x = forloop.index0 %}
          {% for back_image in group.back_image.value %}
            {% assign y = forloop.index0 %}
            {% if x == y %}
              {% assign back_image_match = back_image %}
              <button
                class="back-swatch {% if x == 0 and forloop.parentloop.index0 == 0 %}active{% endif %}"
                data-back-image="{{ back_image_match | image_url }}"
                data-back-logo-placement="{{ group.back_logo_placement }}"
              >
                <img src="{{ back_swatch | img_url: '100x100' }}" alt="Back Swatch {{ x }}">
              </button>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>
</div>
  {% endif %}

  <!-- LEFT SLEEVE DESIGN SWATCHES -->
  {% if has_left_sleeve %}
  <div class="left-sleeve-designs {% if has_left_sleeve %}active{% endif %} ryder-cup--custom--blocks">
    <div class="ryder-container--custom text-container--left-sleeve--custom">
      LEFT SLEEVE DESIGN
    </div>
    <div class="patter-container--left-sleeve--custom" data-block-id="0">
      {% for group in ryder_cup %}
        {% if group.left_sleeve %}
          <div
            class="left-sleeve-button-group-wrapper {% if forloop.first %}active{% endif %}"
            data-group-id="{{ forloop.index0 }}"
            {% unless forloop.index0 == 0 %}style="display: none;"{% endunless %}
          >
            {% for left_sleeve_swatch in group.left_sleeve.value %}
              {% assign x = forloop.index0 %}
              {% assign matched_preview_image = '' %}
              {% for preview_image in group.left_sleeve_preview_image.value %}
                {% assign y = forloop.index0 %}
                {% if x == y %}
                  {% assign matched_preview_image = preview_image %}
                  {% break %}
                {% endif %}
              {% endfor %}
              <button
                class="button-group--left-sleeve--custom {% if forloop.first and forloop.parentloop.first %}active{% endif %}"
                data-sleeve-id="{{ forloop.index0 }}"
                data-block-id="{{ forloop.parentloop.index0 }}"
                data-image-name="{{ left_sleeve_swatch | image_url | split: 'files/' | last | split: '.' | first }}"
                {% if matched_preview_image != '' %} data-left-sleeve-preview-image="{{ matched_preview_image | image_url }}" {% endif %}
              >
                <div class="swatch-preview--left-sleeve--custom">
                  {{ left_sleeve_swatch | image_url: width: 100 | image_tag: class: 'img' }}
                </div>
              </button>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- RIGHT SLEEVE DESIGN SWATCHES -->
  {% if has_right_sleeve %}
  <div class="right-sleeve-designs {% if has_right_sleeve %}active{% endif %} ryder-cup--custom--blocks">
    <div class="ryder-container--custom text-container--right-sleeve--custom">
      RIGHT SLEEVE DESIGN
    </div>
    <div class="patter-container--right-sleeve--custom" data-block-id="0">
      {% for group in ryder_cup %}
        {% if group.right_sleeve %}
          <div
            class="right-sleeve-button-group-wrapper {% if forloop.first %}active{% endif %}"
            data-group-id="{{ forloop.index0 }}"
            {% unless forloop.index0 == 0 %}style="display: none;"{% endunless %}
          >
            {% for right_sleeve_swatch in group.right_sleeve.value %}
              {% assign x = forloop.index0 %}
              {% assign matched_preview_image = '' %}
              {% for preview_image in group.right_sleeve_preview_image.value %}
                {% assign y = forloop.index0 %}
                {% if x == y %}
                  {% assign matched_preview_image = preview_image %}
                  {% break %}
                {% endif %}
              {% endfor %}
              <button
                class="button-group--right-sleeve--custom {% if forloop.first and forloop.parentloop.first %}active{% endif %}"
                data-sleeve-id="{{ forloop.index0 }}"
                data-block-id="{{ forloop.parentloop.index0 }}"
                data-image-name="{{ right_sleeve_swatch | image_url | split: 'files/' | last | split: '.' | first }}"
                {% if matched_preview_image != '' %} data-right-sleeve-preview-image="{{ matched_preview_image | image_url }}" {% endif %}
              >
                <div class="swatch-preview--right-sleeve--custom">
                  {{ right_sleeve_swatch | image_url: width: 100 | image_tag: class: 'img' }}
                </div>
              </button>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- RIGHT BACK SHOULDER, ON POCKET, BOTTOM HEM … (unchanged) -->
  {% if has_right_back_shoulder %}
    <div class="right-back-shoulder-designs {% if has_right_back_shoulder %}active{% endif %} ryder-cup--custom--blocks">
      <div class="ryder-container--custom text-container--right-back-shoulder--custom">
        RIGHT BACK SHOULDER DESIGN
      </div>
      <div class="patter-container--right-back-shoulder--custom" data-block-id="0">
        {% for group in ryder_cup %}
          {% if group.right_back_shoulder %}
            <div
              class="right-back-shoulder-button-group-wrapper {% if forloop.first %}active{% endif %}"
              data-group-id="{{ forloop.index0 }}"
              {% unless forloop.index0 == 0 %}style="display: none;"{% endunless %}
            >
              {% for right_back_shoulder_swatch in group.right_back_shoulder.value %}
                <button
                  class="button-group--right-back-shoulder--custom {% if forloop.first and forloop.parentloop.first %}active{% endif %}"
                  data-shoulder-id="{{ forloop.index0 }}"
                  data-block-id="{{ forloop.parentloop.index0 }}"
                  data-image-name="{{ right_back_shoulder_swatch | image_url | split: 'files/' | last | split: '.' | first }}"
                >
                  <div class="swatch-preview--right-back-shoulder--custom">
                    {{ right_back_shoulder_swatch | image_url: width: 100 | image_tag: class: 'img' }}
                  </div>
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if has_on_pocket_right_side %}
    <div class="on-pocket-right-side-designs {% if has_on_pocket_right_side %}active{% endif %} ryder-cup--custom--blocks">
      <div class="ryder-container--custom text-container--on-pocket-right-side--custom">
        ON POCKET RIGHT SIDE DESIGN
      </div>
      <div class="patter-container--on-pocket-right-side--custom" data-block-id="0">
        {% for group in ryder_cup %}
          {% if group.on_pocket_right_side %}
            <div
              class="on-pocket-right-side-button-group-wrapper {% if forloop.first %}active{% endif %}"
              data-group-id="{{ forloop.index0 }}"
              {% unless forloop.index0 == 0 %}style="display: none;"{% endunless %}
            >
              {% for on_pocket_right_side_swatch in group.on_pocket_right_side.value %}
                <button
                  class="button-group--on-pocket-right-side--custom {% if forloop.first and forloop.parentloop.first %}active{% endif %}"
                  data-pocket-id="{{ forloop.index0 }}"
                  data-block-id="{{ forloop.parentloop.index0 }}"
                  data-image-name="{{ on_pocket_right_side_swatch | image_url | split: 'files/' | last | split: '.' | first }}"
                >
                  <div class="swatch-preview--on-pocket-right-side--custom">
                    {{ on_pocket_right_side_swatch | image_url: width: 100 | image_tag: class: 'img' }}
                  </div>
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if has_bottom_hem %}
    <div class="bottom-hem-designs {% if has_bottom_hem %}active{% endif %} ryder-cup--custom--blocks">
      <div class="ryder-container--custom text-container--bottom-hem--custom">
        BOTTOM HEM DESIGN
      </div>
      <div class="patter-container--bottom-hem--custom" data-block-id="0">
        {% for group in ryder_cup %}
          {% if group.bottom_hem %}
            <div
              class="bottom-hem-button-group-wrapper {% if forloop.first %}active{% endif %}"
              data-group-id="{{ forloop.index0 }}"
              {% unless forloop.index0 == 0 %}style="display: none;"{% endunless %}
            >
              {% for bottom_hem_swatch in group.bottom_hem.value %}
                <button
                  class="button-group--bottom-hem--custom {% if forloop.first and forloop.parentloop.first %}active{% endif %}"
                  data-hem-id="{{ forloop.index0 }}"
                  data-block-id="{{ forloop.parentloop.index0 }}"
                  data-image-name="{{ bottom_hem_swatch | image_url | split: 'files/' | last | split: '.' | first }}"
                >
                  <div class="swatch-preview--bottom-hem--custom">
                    {{ bottom_hem_swatch | image_url: width: 100 | image_tag: class: 'img' }}
                  </div>
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = 'product_selected_designs_v1';
  const defaultState = {
    frontDesign: '',
    backDesign: '',
    leftSleeveDesign: '',
    rightSleeveDesign: '',
    rightBackShoulderDesign: '',
    onPocketRightSideDesign: '',
    bottomHemDesign: '',
    frontPlacement: '',
    backPlacement: '',
    frontSwatchIndex: 0,
    backSwatchIndex: 0,
    leftSleeveSwatchIndex: 0,
    rightSleeveSwatchIndex: 0,
    rightBackShoulderSwatchIndex: 0,
    onPocketRightSideSwatchIndex: 0,
    bottomHemSwatchIndex: 0,
    sleevePreviewActive: false,
    sleevePreviewSrc: ''
  };

  // --- helpers ---
  const $ = (s, root = document) => root.querySelector(s);
  const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));
  const nowCacheBuster = () => `cb=${Date.now()}`;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? Object.assign({}, defaultState, JSON.parse(raw)) : { ...defaultState };
    } catch (e) {
      console.warn('Failed to load state:', e);
      return { ...defaultState };
    }
  }
  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { console.warn(e); }
  }
  function setHiddenValue(selector, value) {
    const el = $(selector);
    if (el) el.value = value;
  }
  function replaceImageElement(imgEl, src) {
    if (!imgEl || !src) return;
    const cacheSrc = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
    const newImg = new Image();
    newImg.src = cacheSrc;
    newImg.className = imgEl.className;
    newImg.loading = imgEl.loading || 'lazy';
    imgEl.parentNode.replaceChild(newImg, imgEl);
  }
  function updateSrcsetForSources(container, baseSrc) {
    if (!container || !baseSrc) return;
    const sources = container.querySelectorAll('source, picture source');
    sources.forEach(source => {
      const srcset = source.getAttribute('srcset') || '';
      const match = srcset.match(/(width=\d+)/);
      const widthPart = match ? match[1] : null;
      const base = baseSrc.split('?')[0];
      const newSrc = widthPart ? `${base}?${widthPart}&${nowCacheBuster()}` : `${base}?${nowCacheBuster()}`;
      source.srcset = newSrc;
    });
  }

  // NEW: Show sleeve preview image
  function showSleevePreview(src) {
    if (!src) return;
    const r = refs();
    state.sleevePreviewActive = true;
    state.sleevePreviewSrc = src;

    // desktop
    if (r.desktopImages[0]) replaceImageElement(r.desktopImages[0], src);

    // mobile
    if (r.mobileImageContainers[0]) {
      const img = $('.pdp__media-tag', r.mobileImageContainers[0]);
      if (img) img.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.mobileImageContainers[0], src);
    }

    // thumb
    if (r.thumbImageContainers[0]) {
      const thumb = r.thumbImageContainers[0].querySelector('.vertical__media');
      if (thumb) thumb.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.thumbImageContainers[0], src);
    }

    reorderDesktopImages(false);
  }

  // --- DOM refs ---
  function refs() {
    return {
      frontSwatches: $$('.front-swatch'),
      backGroups: $$('.back-swatches-group'),
      leftSleeveGroups: $$('.left-sleeve-button-group-wrapper'),
      rightSleeveGroups: $$('.right-sleeve-button-group-wrapper'),
      rightBackShoulderGroups: $$('.right-back-shoulder-button-group-wrapper'),
      onPocketRightSideGroups: $$('.on-pocket-right-side-button-group-wrapper'),
      bottomHemGroups: $$('.bottom-hem-button-group-wrapper'),
      leftSleeveDesigns: $('.left-sleeve-designs'),
      rightSleeveDesigns: $('.right-sleeve-designs'),
      rightBackShoulderDesigns: $('.right-back-shoulder-designs'),
      onPocketRightSideDesigns: $('.on-pocket-right-side-designs'),
      bottomHemDesigns: $('.bottom-hem-designs'),
      frontDesignInput: '#front-design-input',
      backDesignInput: '#back-design-input',
      leftSleeveDesignInput: '#left-sleeve-design-input',
      rightSleeveDesignInput: '#right-sleeve-design-input',
      rightBackShoulderDesignInput: '#right-back-shoulder-design-input',
      onPocketRightSideDesignInput: '#on-pocket-right-side-design-input',
      bottomHemDesignInput: '#bottom-hem-design-input',
      frontPlacementInput: '#front-placement-input',
      backPlacementInput: '#back-placement-input',
      desktopImageContainers: $$('.main-product-logo--custom .info-media-stack-wrapper .pdp-media'),
      desktopImages: $$('.main-product-logo--custom .info-media-stack-wrapper .pdp__media-tag'),
      mobileImageContainers: $$('.main-product-logo--custom .pdp-media-sm .main-swiper .swiper-slide .pdp-media-image'),
      thumbImageContainers: $$('.main-product-logo--custom .vertical__medias .pdp-media-v')
    };
  }

  // --- core logic ---
  let state = loadState();

  function applyGroupVisibility(groupIndex) {
    const {
      leftSleeveDesigns, rightSleeveDesigns, rightBackShoulderDesigns,
      onPocketRightSideDesigns, bottomHemDesigns
    } = refs();
    const front = $$('.front-swatch').find(f => f.dataset.groupIndex === groupIndex) || null;
    const hasLeft = front ? front.dataset.hasLeftSleeve === 'true' : false;
    const hasRight = front ? front.dataset.hasRightSleeve === 'true' : false;
    const hasRightBackShoulder = front ? front.dataset.hasRightBackShoulder === 'true' : false;
    const hasOnPocketRightSide = front ? front.dataset.hasOnPocketRightSide === 'true' : false;
    const hasBottomHem = front ? front.dataset.hasBottomHem === 'true' : false;

    if (leftSleeveDesigns) leftSleeveDesigns.classList.toggle('active', hasLeft);
    if (rightSleeveDesigns) rightSleeveDesigns.classList.toggle('active', hasRight);
    if (rightBackShoulderDesigns) rightBackShoulderDesigns.classList.toggle('active', hasRightBackShoulder);
    if (onPocketRightSideDesigns) onPocketRightSideDesigns.classList.toggle('active', hasOnPocketRightSide);
    if (bottomHemDesigns) bottomHemDesigns.classList.toggle('active', hasBottomHem);

// --- BACK DESIGN VISIBILITY (fixed) ---
const backWrapper = $('.back-designs-wrapper');
const hasBackForThisGroup = $$('.back-swatches-group').some(bg => 
  bg.dataset.groupIndex === groupIndex && bg.children.length > 0
);

if (backWrapper) {
  backWrapper.classList.toggle('active', hasBackForThisGroup);
}

// Show only the matching back swatches group
refs().backGroups.forEach(bg => {
  const shouldShow = bg.dataset.groupIndex === groupIndex && bg.children.length > 0;
  bg.classList.toggle('active', shouldShow);
  bg.style.display = shouldShow ? 'flex' : 'none';
  
  if (!shouldShow) {
    $$('.back-swatch', bg).forEach(b => b.classList.remove('active'));
  }
});
    refs().leftSleeveGroups.forEach(lg => {
      const is = lg.dataset.groupId === groupIndex;
      lg.style.display = is ? 'flex' : 'none';
      lg.classList.toggle('active', is);
      if (!is) $$('.button-group--left-sleeve--custom', lg).forEach(b => b.classList.remove('active'));
    });
    refs().rightSleeveGroups.forEach(rg => {
      const is = rg.dataset.groupId === groupIndex;
      rg.style.display = is ? 'flex' : 'none';
      rg.classList.toggle('active', is);
      if (!is) $$('.button-group--right-sleeve--custom', rg).forEach(b => b.classList.remove('active'));
    });
    refs().rightBackShoulderGroups.forEach(rg => {
      const is = rg.dataset.groupId === groupIndex;
      rg.style.display = is ? 'flex' : 'none';
      rg.classList.toggle('active', is);
      if (!is) $$('.button-group--right-back-shoulder--custom', rg).forEach(b => b.classList.remove('active'));
    });
    refs().onPocketRightSideGroups.forEach(rg => {
      const is = rg.dataset.groupId === groupIndex;
      rg.style.display = is ? 'flex' : 'none';
      rg.classList.toggle('active', is);
      if (!is) $$('.button-group--on-pocket-right-side--custom', rg).forEach(b => b.classList.remove('active'));
    });
    refs().bottomHemGroups.forEach(rg => {
      const is = rg.dataset.groupId === groupIndex;
      rg.style.display = is ? 'flex' : 'none';
      rg.classList.toggle('active', is);
      if (!is) $$('.button-group--bottom-hem--custom', rg).forEach(b => b.classList.remove('active'));
    });
  }

  function restoreUIFromState() {
    const r = refs();

    // front
    if (r.frontSwatches.length) {
      r.frontSwatches.forEach(f => f.classList.remove('active'));
      const fIndex = Math.min(Math.max(0, state.frontSwatchIndex), r.frontSwatches.length - 1);
      const front = r.frontSwatches[fIndex];
      if (front) front.classList.add('active');
      const groupIndex = front ? front.dataset.groupIndex : (r.frontSwatches[0] && r.frontSwatches[0].dataset.groupIndex);
      if (groupIndex) applyGroupVisibility(groupIndex);
    }

    // back
    r.backGroups.forEach(bg => {
      const backButtons = $$('.back-swatch', bg);
      backButtons.forEach(b => b.classList.remove('active'));
      if (bg.dataset.groupIndex === (r.frontSwatches[r.frontSwatches.findIndex(s => s.classList.contains('active'))]?.dataset.groupIndex)) {
        bg.classList.add('active');
        const idx = Math.min(Math.max(0, state.backSwatchIndex), backButtons.length - 1);
        if (backButtons[idx]) backButtons[idx].classList.add('active');
      } else {
        bg.classList.remove('active');
      }
    });

    // left sleeve
    r.leftSleeveGroups.forEach(lg => {
      const buttons = $$('.button-group--left-sleeve--custom', lg);
      buttons.forEach(b => b.classList.remove('active'));
      if (lg.classList.contains('active') && buttons.length) {
        const idx = Math.min(Math.max(0, state.leftSleeveSwatchIndex), buttons.length - 1);
        if (buttons[idx]) buttons[idx].classList.add('active');
      }
    });

    // right sleeve
    r.rightSleeveGroups.forEach(rg => {
      const buttons = $$('.button-group--right-sleeve--custom', rg);
      buttons.forEach(b => b.classList.remove('active'));
      if (rg.classList.contains('active') && buttons.length) {
        const idx = Math.min(Math.max(0, state.rightSleeveSwatchIndex), buttons.length - 1);
        if (buttons[idx]) buttons[idx].classList.add('active');
      }
    });

    // right back shoulder
    r.rightBackShoulderGroups.forEach(rg => {
      const buttons = $$('.button-group--right-back-shoulder--custom', rg);
      buttons.forEach(b => b.classList.remove('active'));
      if (rg.classList.contains('active') && buttons.length) {
        const idx = Math.min(Math.max(0, state.rightBackShoulderSwatchIndex), buttons.length - 1);
        if (buttons[idx]) buttons[idx].classList.add('active');
      }
    });

    // on pocket right side
    r.onPocketRightSideGroups.forEach(rg => {
      const buttons = $$('.button-group--on-pocket-right-side--custom', rg);
      buttons.forEach(b => b.classList.remove('active'));
      if (rg.classList.contains('active') && buttons.length) {
        const idx = Math.min(Math.max(0, state.onPocketRightSideSwatchIndex), buttons.length - 1);
        if (buttons[idx]) buttons[idx].classList.add('active');
      }
    });

    // bottom hem
    r.bottomHemGroups.forEach(rg => {
      const buttons = $$('.button-group--bottom-hem--custom', rg);
      buttons.forEach(b => b.classList.remove('active'));
      if (rg.classList.contains('active') && buttons.length) {
        const idx = Math.min(Math.max(0, state.bottomHemSwatchIndex), buttons.length - 1);
        if (buttons[idx]) buttons[idx].classList.add('active');
      }
    });

    updateMainImages(false);
    updateHiddenInputs();
  }

  function updateHiddenInputs() {
    setHiddenValue('#front-design-input', state.frontDesign);
    setHiddenValue('#back-design-input', state.backDesign);
    setHiddenValue('#left-sleeve-design-input', state.leftSleeveDesign);
    setHiddenValue('#right-sleeve-design-input', state.rightSleeveDesign);
    setHiddenValue('#right-back-shoulder-design-input', state.rightBackShoulderDesign);
    setHiddenValue('#on-pocket-right-side-design-input', state.onPocketRightSideDesign);
    setHiddenValue('#bottom-hem-design-input', state.bottomHemDesign);
    setHiddenValue('#front-placement-input', state.frontPlacement);
    setHiddenValue('#back-placement-input', state.backPlacement);
  }

  function reorderDesktopImages(isBackClicked) {
    const { desktopImageContainers } = refs();
    if (desktopImageContainers.length < 2) return;
    const wrapper = document.querySelector('.info-media-stack-wrapper');
    if (!wrapper) return;
    if (isBackClicked) {
      const back = desktopImageContainers[1];
      const firstChild = wrapper.firstElementChild;
      if (back && back !== firstChild) wrapper.insertBefore(back, firstChild);
    } else {
      const front = desktopImageContainers[0];
      if (front && front !== wrapper.firstElementChild) wrapper.insertBefore(front, wrapper.firstElementChild);
    }
  }

  // FIXED: updateMainImages now accepts clickEvent and clears sleeve preview on front/back
function updateMainImages(isBackSwatchClicked = false, clickEvent = null) {
  // Drop sleeve preview if coming from front or back click
  const fromFront = clickEvent?.target?.closest('.front-swatch');
  const fromBack  = clickEvent?.target?.closest('.back-swatch');
  if (state.sleevePreviewActive && (fromFront || fromBack)) {
    state.sleevePreviewActive = false;
    state.sleevePreviewSrc = '';
  }

  const r = refs();
  const activeFront = r.frontSwatches.find(s => s.classList.contains('active')) || null;
  const activeBackGroup = r.backGroups.find(g => g.classList.contains('active')) || null;
  const activeBack = activeBackGroup
    ? $$('.back-swatch', activeBackGroup).find(b => b.classList.contains('active'))
    : null;

  reorderDesktopImages(isBackSwatchClicked);

  // FRONT: Only update if NO sleeve preview is active
  if (activeFront && activeFront.dataset.frontImage && !state.sleevePreviewActive) {
    const src = activeFront.dataset.frontImage;

    if (r.desktopImages[0]) replaceImageElement(r.desktopImages[0], src);
    if (r.mobileImageContainers[0]) {
      const img = $('.pdp__media-tag', r.mobileImageContainers[0]);
      if (img) img.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.mobileImageContainers[0], src);
    }
    if (r.thumbImageContainers[0]) {
      const thumb = r.thumbImageContainers[0].querySelector('.vertical__media');
      if (thumb) thumb.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.thumbImageContainers[0], src);
    }

    {% comment %} state.frontDesign = (activeFront.dataset.frontImage || '').split('files/').pop()?.split('.').shift() || '';
    state.frontPlacement = activeFront.dataset.frontLogoPlacement || ''; {% endcomment %}

    const placement = activeFront.dataset.frontLogoPlacement || '';

    if (placement === 'none') {
      state.frontPlacement = '';
      state.frontDesign = '';  // No logo → empty value
    } else {
      state.frontPlacement = placement;
      state.frontDesign = (activeFront.dataset.frontImage || '')
        .split('files/').pop()?.split('.').shift() || '';
    }

    state.frontSwatchIndex = r.frontSwatches.findIndex(s => s === activeFront);
  } else if (!state.sleevePreviewActive) {
    state.frontDesign = '';
    state.frontPlacement = '';
    state.frontSwatchIndex = 0;
  }

  // BACK: Always update (back never conflicts with sleeve preview)
  if (activeBack && activeBack.dataset.backImage) {
    const src = activeBack.dataset.backImage;

    if (r.desktopImages[1]) replaceImageElement(r.desktopImages[1], src);
    if (r.mobileImageContainers[1]) {
      const img = $('.pdp__media-tag', r.mobileImageContainers[1]);
      if (img) img.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.mobileImageContainers[1], src);
    }
    if (r.thumbImageContainers[1]) {
      const thumb = r.thumbImageContainers[1].querySelector('.vertical__media');
      if (thumb) thumb.src = src.includes('?') ? `${src}&${nowCacheBuster()}` : `${src}?${nowCacheBuster()}`;
      updateSrcsetForSources(r.thumbImageContainers[1], src);
    }

    state.backDesign = (activeBack.dataset.backImage || '').split('files/').pop()?.split('.').shift() || '';
    state.backPlacement = activeBack.dataset.backLogoPlacement || '';
    if (activeBackGroup) {
      const btns = $$('.back-swatch', activeBackGroup);
      state.backSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    } else state.backSwatchIndex = 0;
  } else {
    state.backDesign = '';
    state.backPlacement = '';
    state.backSwatchIndex = 0;
  }

  // LEFT SLEEVE
  const activeLeftSleeve = r.leftSleeveDesigns ? $('.button-group--left-sleeve--custom.active', r.leftSleeveDesigns) : null;
  if (activeLeftSleeve && activeLeftSleeve.dataset.imageName) {
    state.leftSleeveDesign = activeLeftSleeve.dataset.imageName;
    const activeGroup = refs().leftSleeveGroups.find(g => g.classList.contains('active'));
    if (activeGroup) {
      const btns = $$('.button-group--left-sleeve--custom', activeGroup);
      state.leftSleeveSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    }
  } else {
    state.leftSleeveDesign = '';
    state.leftSleeveSwatchIndex = 0;
  }

  // RIGHT SLEEVE
  const activeRightSleeve = r.rightSleeveDesigns ? $('.button-group--right-sleeve--custom.active', r.rightSleeveDesigns) : null;
  if (activeRightSleeve && activeRightSleeve.dataset.imageName) {
    state.rightSleeveDesign = activeRightSleeve.dataset.imageName;
    const activeGroup = refs().rightSleeveGroups.find(g => g.classList.contains('active'));
    if (activeGroup) {
      const btns = $$('.button-group--right-sleeve--custom', activeGroup);
      state.rightSleeveSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    }
  } else {
    state.rightSleeveDesign = '';
    state.rightSleeveSwatchIndex = 0;
  }

  // RIGHT BACK SHOULDER
  const activeRightBackShoulder = r.rightBackShoulderDesigns ? $('.button-group--right-back-shoulder--custom.active', r.rightBackShoulderDesigns) : null;
  if (activeRightBackShoulder && activeRightBackShoulder.dataset.imageName) {
    state.rightBackShoulderDesign = activeRightBackShoulder.dataset.imageName;
    const activeGroup = refs().rightBackShoulderGroups.find(g => g.classList.contains('active'));
    if (activeGroup) {
      const btns = $$('.button-group--right-back-shoulder--custom', activeGroup);
      state.rightBackShoulderSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    }
  } else {
    state.rightBackShoulderDesign = '';
    state.rightBackShoulderSwatchIndex = 0;
  }

  // ON POCKET RIGHT SIDE
  const activeOnPocketRightSide = r.onPocketRightSideDesigns ? $('.button-group--on-pocket-right-side--custom.active', r.onPocketRightSideDesigns) : null;
  if (activeOnPocketRightSide && activeOnPocketRightSide.dataset.imageName) {
    state.onPocketRightSideDesign = activeOnPocketRightSide.dataset.imageName;
    const activeGroup = refs().onPocketRightSideGroups.find(g => g.classList.contains('active'));
    if (activeGroup) {
      const btns = $$('.button-group--on-pocket-right-side--custom', activeGroup);
      state.onPocketRightSideSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    }
  } else {
    state.onPocketRightSideDesign = '';
    state.onPocketRightSideSwatchIndex = 0;
  }

  // BOTTOM HEM
  const activeBottomHem = r.bottomHemDesigns ? $('.button-group--bottom-hem--custom.active', r.bottomHemDesigns) : null;
  if (activeBottomHem && activeBottomHem.dataset.imageName) {
    state.bottomHemDesign = activeBottomHem.dataset.imageName;
    const activeGroup = refs().bottomHemGroups.find(g => g.classList.contains('active'));
    if (activeGroup) {
      const btns = $$('.button-group--bottom-hem--custom', activeGroup);
      state.bottomHemSwatchIndex = btns.findIndex(b => b.classList.contains('active'));
    }
  } else {
    state.bottomHemDesign = '';
    state.bottomHemSwatchIndex = 0;
  }

  updateHiddenInputs();
  saveState();

  const mainSwiper = document.querySelector('.pdp-media-sm .main-swiper');
  if (mainSwiper && typeof Swiper !== 'undefined' && mainSwiper.swiper) {
    try {
      const swiperInstance = mainSwiper.swiper;
      swiperInstance.update();
      swiperInstance.slideTo(isBackSwatchClicked ? 1 : 0);
    } catch (e) { console.warn('Swiper update failed', e); }
  }
}

  // --- event handling (delegation) ---
  document.addEventListener('click', (ev) => {
    // FRONT
    const front = ev.target.closest('.front-swatch');
    if (front) {
      refs().frontSwatches.forEach(f => f.classList.remove('active'));
      front.classList.add('active');
      state.frontSwatchIndex = refs().frontSwatches.findIndex(f => f === front);
      const groupIndex = front.dataset.groupIndex;
      applyGroupVisibility(groupIndex);

      const group = refs().backGroups.find(bg => bg.dataset.groupIndex === groupIndex);
      if (group) {
        const backBtns = $$('.back-swatch', group);
        if (!backBtns.some(b => b.classList.contains('active')) && backBtns.length) {
          backBtns[0].classList.add('active');
          state.backSwatchIndex = 0;
        }
        refs().backGroups.forEach(bg => bg.classList.toggle('active', bg === group));
      }

      refs().leftSleeveGroups.forEach(lg => {
        const is = lg.dataset.groupId === groupIndex;
        lg.style.display = is ? 'flex' : 'none';
        lg.classList.toggle('active', is);
        if (is && !$$('.button-group--left-sleeve--custom', lg).some(b => b.classList.contains('active')) && $$('.button-group--left-sleeve--custom', lg).length) {
          $$('.button-group--left-sleeve--custom', lg)[0].classList.add('active');
          state.leftSleeveSwatchIndex = 0;
        }
      });
      refs().rightSleeveGroups.forEach(rg => {
        const is = rg.dataset.groupId === groupIndex;
        rg.style.display = is ? 'flex' : 'none';
        rg.classList.toggle('active', is);
        if (is && !$$('.button-group--right-sleeve--custom', rg).some(b => b.classList.contains('active')) && $$('.button-group--right-sleeve--custom', rg).length) {
          $$('.button-group--right-sleeve--custom', rg)[0].classList.add('active');
          state.rightSleeveSwatchIndex = 0;
        }
      });
      refs().rightBackShoulderGroups.forEach(rg => {
        const is = rg.dataset.groupId === groupIndex;
        rg.style.display = is ? 'flex' : 'none';
        rg.classList.toggle('active', is);
        if (is && !$$('.button-group--right-back-shoulder--custom', rg).some(b => b.classList.contains('active')) && $$('.button-group--right-back-shoulder--custom', rg).length) {
          $$('.button-group--right-back-shoulder--custom', rg)[0].classList.add('active');
          state.rightBackShoulderSwatchIndex = 0;
        }
      });
      refs().onPocketRightSideGroups.forEach(rg => {
        const is = rg.dataset.groupId === groupIndex;
        rg.style.display = is ? 'flex' : 'none';
        rg.classList.toggle('active', is);
        if (is && !$$('.button-group--on-pocket-right-side--custom', rg).some(b => b.classList.contains('active')) && $$('.button-group--on-pocket-right-side--custom', rg).length) {
          $$('.button-group--on-pocket-right-side--custom', rg)[0].classList.add('active');
          state.onPocketRightSideSwatchIndex = 0;
        }
      });
      refs().bottomHemGroups.forEach(rg => {
        const is = rg.dataset.groupId === groupIndex;
        rg.style.display = is ? 'flex' : 'none';
        rg.classList.toggle('active', is);
        if (is && !$$('.button-group--bottom-hem--custom', rg).some(b => b.classList.contains('active')) && $$('.button-group--bottom-hem--custom', rg).length) {
          $$('.button-group--bottom-hem--custom', rg)[0].classList.add('active');
          state.bottomHemSwatchIndex = 0;
        }
      });

      updateMainImages(false, ev);  // PASS ev
      return;
    }

    // BACK
    const back = ev.target.closest('.back-swatch');
    if (back) {
      const group = ev.target.closest('.back-swatches-group');
      if (group) {
        $$('.back-swatch', group).forEach(b => b.classList.remove('active'));
        back.classList.add('active');
        refs().backGroups.forEach(bg => bg.classList.remove('active'));
        group.classList.add('active');
        state.backSwatchIndex = $$('.back-swatch', group).findIndex(b => b === back);
        updateMainImages(true, ev);  // PASS ev
      }
      return;
    }

// LEFT SLEEVE
const leftBtn = ev.target.closest('.button-group--left-sleeve--custom');
if (leftBtn) {
  const group = ev.target.closest('.left-sleeve-button-group-wrapper');
  if (group) {
    $$('.button-group--left-sleeve--custom', group).forEach(b => b.classList.remove('active'));
    leftBtn.classList.add('active');

    state.leftSleeveSwatchIndex = $$('.button-group--left-sleeve--custom', group).findIndex(b => b === leftBtn);
    state.leftSleeveDesign = leftBtn.dataset.imageName || '';

    const preview = leftBtn.dataset.leftSleevePreviewImage;
    if (preview) {
      showSleevePreview(preview);
    } else {
      state.sleevePreviewActive = false;
      updateMainImages(false);
    }

    updateHiddenInputs();
    saveState();
  }
  return;
}

// RIGHT SLEEVE
const rightBtn = ev.target.closest('.button-group--right-sleeve--custom');
if (rightBtn) {
  const group = ev.target.closest('.right-sleeve-button-group-wrapper');
  if (group) {
    $$('.button-group--right-sleeve--custom', group).forEach(b => b.classList.remove('active'));
    rightBtn.classList.add('active');

    state.rightSleeveSwatchIndex = $$('.button-group--right-sleeve--custom', group).findIndex(b => b === rightBtn);
    state.rightSleeveDesign = rightBtn.dataset.imageName || '';

    const preview = rightBtn.dataset.rightSleevePreviewImage;
    if (preview) {
      showSleevePreview(preview);
    } else {
      state.sleevePreviewActive = false;
      updateMainImages(false);
    }

    updateHiddenInputs();
    saveState();
  }
  return;
}

    // RIGHT BACK SHOULDER
    const rightBackShoulderBtn = ev.target.closest('.button-group--right-back-shoulder--custom');
    if (rightBackShoulderBtn) {
      const group = ev.target.closest('.right-back-shoulder-button-group-wrapper');
      if (group) {
        $$('.button-group--right-back-shoulder--custom', group).forEach(b => b.classList.remove('active'));
        rightBackShoulderBtn.classList.add('active');
        state.rightBackShoulderSwatchIndex = $$('.button-group--right-back-shoulder--custom', group).findIndex(b => b === rightBackShoulderBtn);
        updateMainImages(false);
      }
      return;
    }

    // ON POCKET RIGHT SIDE
    const onPocketBtn = ev.target.closest('.button-group--on-pocket-right-side--custom');
    if (onPocketBtn) {
      const group = ev.target.closest('.on-pocket-right-side-button-group-wrapper');
      if (group) {
        $$('.button-group--on-pocket-right-side--custom', group).forEach(b => b.classList.remove('active'));
        onPocketBtn.classList.add('active');
        state.onPocketRightSideSwatchIndex = $$('.button-group--on-pocket-right-side--custom', group).findIndex(b => b === onPocketBtn);
        updateMainImages(false);
      }
      return;
    }

    // BOTTOM HEM
    const bottomHemBtn = ev.target.closest('.button-group--bottom-hem--custom');
    if (bottomHemBtn) {
      const group = ev.target.closest('.bottom-hem-button-group-wrapper');
      if (group) {
        $$('.button-group--bottom-hem--custom', group).forEach(b => b.classList.remove('active'));
        bottomHemBtn.classList.add('active');
        state.bottomHemSwatchIndex = $$('.button-group--bottom-hem--custom', group).findIndex(b => b === bottomHemBtn);
        updateMainImages(false);
      }
      return;
    }
  });

  // variant change
  document.addEventListener('variant:change', () => {
    state.sleevePreviewActive = false;
    state.sleevePreviewSrc = '';
    restoreUIFromState();
  });

  // initial setup
  (function init() {
    const r = refs();
    if (!r.frontSwatches.length) { console.error('No front swatches found'); return; }

    if (!r.frontSwatches.some(s => s.classList.contains('active'))) {
      r.frontSwatches[0].classList.add('active');
      state.frontSwatchIndex = 0;
      const fi = r.frontSwatches[0];
      const groupIndex = fi.dataset.groupIndex;
      applyGroupVisibility(groupIndex);

      const matchingBackGroup = r.backGroups.find(bg => bg.dataset.groupIndex === groupIndex);
      if (matchingBackGroup) {
        matchingBackGroup.classList.add('active');
        const backBtns = $$('.back-swatch', matchingBackGroup);
        if (backBtns.length) { backBtns[0].classList.add('active'); state.backSwatchIndex = 0; }
      }

      r.leftSleeveGroups.forEach(lg => {
        if (lg.dataset.groupId === groupIndex) {
          lg.style.display = 'flex';
          lg.classList.add('active');
          const leftBtns = $$('.button-group--left-sleeve--custom', lg);
          if (leftBtns.length) leftBtns[0].classList.add('active');
        } else lg.style.display = 'none';
      });
      r.rightSleeveGroups.forEach(rg => {
        if (rg.dataset.groupId === groupIndex) {
          rg.style.display = 'flex';
          rg.classList.add('active');
          const rightBtns = $$('.button-group--right-sleeve--custom', rg);
          if (rightBtns.length) rightBtns[0].classList.add('active');
        } else rg.style.display = 'none';
      });
      r.rightBackShoulderGroups.forEach(rg => {
        if (rg.dataset.groupId === groupIndex) {
          rg.style.display = 'flex';
          rg.classList.add('active');
          const rightBtns = $$('.button-group--right-back-shoulder--custom', rg);
          if (rightBtns.length) rightBtns[0].classList.add('active');
        } else rg.style.display = 'none';
      });
      r.onPocketRightSideGroups.forEach(rg => {
        if (rg.dataset.groupId === groupIndex) {
          rg.style.display = 'flex';
          rg.classList.add('active');
          const rightBtns = $$('.button-group--on-pocket-right-side--custom', rg);
          if (rightBtns.length) rightBtns[0].classList.add('active');
        } else rg.style.display = 'none';
      });
      r.bottomHemGroups.forEach(rg => {
        if (rg.dataset.groupId === groupIndex) {
          rg.style.display = 'flex';
          rg.classList.add('active');
          const rightBtns = $$('.button-group--bottom-hem--custom', rg);
          if (rightBtns.length) rightBtns[0].classList.add('active');
        } else rg.style.display = 'none';
      });
    }

    restoreUIFromState();
  })();
});
</script>