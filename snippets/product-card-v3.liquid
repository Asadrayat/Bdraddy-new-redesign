{% assign has_video = false %}
{% if product.metafields.custom.product_card_featured_video %}
  {% assign has_video = true %}
{% endif %}

<div class="--product-card-v3 --august-product-card">
  <div class="--image-wrapper">
    {% if product.compare_at_price > product.price and collection.metafields.custom.is_sale_collection == true %}
      <div class="--sale-percentage-badge">
        {{
          product.compare_at_price
          | minus: product.price
          | times: 100
          | divided_by: product.compare_at_price
          | round
          | append: '% OFF'
        }}
      </div>
    {% elsif settings.enable_custom_price == true and product.metafields.custom.exclude_from_custom_pricing != true %}
      <div class="--sale-percentage-badge">
        {{ settings.discount_percentage | append: '% OFF WITH CODE' }}
      </div>
    {% endif %}
    <a class="absolute-link" href="{{ product.selected_or_first_available_variant.url | within: collection }}"></a>
      {% if has_video %}
        <div class="product-card__video-wrapper">
          {{ product.metafields.custom.product_card_featured_video.value | video_tag: 
            controls: false, 
            autoplay: true, 
            muted: true, 
            loop: true, 
            width: '500px',
            playsinline: true,
            class: 'product-card__primary-video'
          }}
          <button id="video-toggle-id" class="product-card__video-toggle" aria-label="Play/Pause video">
            <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
          </button>
        </div>
      {% else %}
        {% if product.selected_or_first_available_variant.image != blank %}
          {{
            product.selected_or_first_available_variant.image
            | image_url: width: 350
            | image_tag: class: '--product-first-image', loading: 'lazy', decoding: 'async'
          }}
        {% elsif product.featured_image != blank %}
          {{
            product.featured_image
            | image_url: width: 350
            | image_tag: class: '--product-first-image', loading: 'lazy', decoding: 'async'
          }}
        {% else %}
          {{ 'image' | placeholder_svg_tag }}
        {% endif %}
        {% assign next_index = product.selected_or_first_available_variant.image.position %}

        {% assign original_index = next_index | minus: 1 %}
        {% if product.media[next_index] != blank %}
          {{
            product.media[next_index]
            | image_url: width: 350
            | image_tag: class: '--product-second-image', loading: 'lazy', decoding: 'async'
          }}
        {% elsif product.media[original_index] != blank %}
          {{
            product.media[original_index]
            | image_url: width: 350
            | image_tag: class: '--product-second-image', loading: 'lazy', decoding: 'async'
          }}
        {% endif %}
    {% endif %}
    <div class="--custom-badge-container {% if collection.metafields.custom.is_sale_collection == true  %} hidden {% endif %}">
      {% if product.vendor == 'Draddy Sport' %}
        <div class="--sport-badge">
          {% render 'all-icons', name: 'draddy-sport-logo' %}
        </div>
      {% endif %}
      {% if product.metafields.custom.product_badge != blank %}
        <div class="--custom-badge-wrapper ">
          {% for badge in product.metafields.custom.product_badge.value limit: 1  %}
            <span class="--single-badge">{{ badge }}</span>
            {% unless forloop.last %}
              <span class="small-hide">|</span>
            {% endunless %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {% comment %}
      <button
        class="--quick-add --quick-add-mobile --quick-add-trigger {{ product.template_suffix }}--hide--quick-add"
        data-url="{{ product.selected_or_first_available_variant.url | within: collection }}"
      >
        {% render 'all-icons', name: 'test-bag' %}
      </button>
    {% endcomment %}
  </div>

  <div class="--product-info">
    <div class="--color-options --quick-add-trigger-- -hidden {% if product.template_suffix == 'custom-logo-product' %}hidden{% endif %}">
      {% for option in product.options_with_values %}
        {% assign option_name = option.name | downcase %}

        {% if option_name == 'color' %}
          {% comment %} {%- assign color_option = option -%} {% endcomment %}
          {%- assign color_option = product.options_with_values | where: 'name', option.name | first -%}
        {% endif %}
      {% endfor %}

      {% # - assign color_option = product.options_with_values | where: 'name', 'Color' | first -%}

      {%- if color_option and color_option.values.size > 0 -%}
        {% for color in color_option.values limit: 3 %}
          {% assign color_handle = color | handle %}
          {% assign swatch_image = color_handle | append: '.png' | file_img_url: '45x' %}
          {% assign color_variant = product.variants | where: 'option1', color | first %}
          {% comment %}
            <span
              class="--color-swatch --quick-add-trigger"
              style="{% if images[color_handle] %}background-image: url({{ swatch_image }});{% else %}background-color: {{ color_handle }};{% endif %}"
              data-url="{{ color_variant.url | within: collection }}"
            >
          {% endcomment %}
          {% comment %} <span
            class="--color-swatch --quick-add-trigger"
            style="background-color: {{ color_handle }};"
            data-url="{{ color_variant.url | within: collection }}"
          >
            {% if images[color_handle] -%}
              <img
                src="{{ swatch_image }}"
                class=""
                style="width: 100%; height: 100%; object-fit: cover; object-position: center;"
                alt="{{  collection.title }}"
                loading="lazy"
                decoding="async"
              >
            {% endif %}
          </span> {% endcomment %}
          <a
            href="{{ color_variant.url | within: collection }}"
            class="--color-swatch --quick-add-trigger"
            style="background-color: {{ color_handle }};"
            data-url="{{ color_variant.url | within: collection }}"
          >
            {% if images[color_handle] -%}
              <img
                src="{{ swatch_image }}"
                class=""
                style="width: 100%; height: 100%; object-fit: cover; object-position: center;"
                alt="{{  collection.title }}"
                loading="lazy"
                decoding="async"
              >
            {% endif %}
          </a>
        {% endfor %}

        {% if color_option.values.size > 3 %}
          <a
            class="--remaining-color-count"
            href="{{ product.selected_or_first_available_variant.url | within: collection }}"
            >+
            {{- color_option.values.size | minus: 3 -}}
          </a>
        {% endif %}
      {% endif %}
    </div>
{% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price or  product.tags contains 'EMBROIDER' or product.tags contains 'embroider' or product.tags contains 'Ryder Cup 2025'%}
      <div class="--sale-badge-on-card">Final Sale</div>
    {% endif %}
    <h3 class="--product-title">
      <a class="absolute-link" href="{{ product.selected_or_first_available_variant.url | within: collection }}"></a>
      {% if product.title contains '|' %}
        {% assign custom_title = product.title | split: '|' %}
        {% for piece in custom_title %}
          {{ piece }}
          {% unless forloop.last %}<br>{% endunless %}
        {% endfor %}

      {% else %}
        {{ product.title }}
      {% endif %}
    </h3>
    {% comment %} <div class="--card-short-description">{{ product.metafields.custom.description_romance_copy }}</div> {% endcomment %}
    {% comment %} <p class="--product-attribute">{{ product.metafields.custom.product_attribute }}</p> {% endcomment %}
     {% if product.metafields.custom.pattern_type.value[0] != blank or product.metafields.custom.unique_element.value[0] != blank %}
    <div class="--product-attribute-wrapper">
       <a class="absolute-link" href="{{ product.selected_or_first_available_variant.url | within: collection }}"></a>
      {% if product.metafields.custom.pattern_type.value[0] != blank %}
        <p class="--product-attribute">{{ product.metafields.custom.pattern_type.value | join: ' ' }}</p>
      {% endif %}
      {% if product.metafields.custom.unique_element.value[0] != blank %}
        <p class="--product-attribute">{{ product.metafields.custom.unique_element.value | join: ' ' }}</p>
      {% endif %}
    </div>
    {% endif %}

    <p class="--color-count hidden">Available in {{ color_option.values.size }} colors.</p>

    <div class="product-card__pricing" data-price-container>
      {%- assign discount_percent = product.metafields.custom.discount_percentage_price.value | default: 0.0 | plus: 0.0 -%}

      {% if discount_percent > 0 %}
        {% render 'new-price-discount', product: product %}
      {% else %}
        {% render 'new-price', product: product %}
      {% endif %}
    </div>

  </div>
</div>
