<nav id="mobile-navigation" class="menu-drawer__navigation menu-drawer__navigation-custom">
  <ul class="parent-m menu-drawer__menu has-submenu list-menu" role="list">
    {%- for link in section.settings.menu.links -%}
      <li
        {% if link.active %}
          class="active {% if link.child_active %}child-active{% endif %}"
        {% endif %}
      >
        <div class="has-sub-menu">
          <a href="{{ link.url }}">{{ link.title }}</a>


        {% liquid
          assign title_handle = link.title | handleize
          assign has_mega_image = false
        %}
        {% for block in section.blocks %}

          {% if block.type == 'image_mega_menu' %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif

              if menu_title == title_handle
                assign has_mega_image = true
              endif
            %}
            {% assign do_images_exist = false %}
            {% if has_mega_image == true %}
              {% for i in (1..5) %}
                {% liquid
                  capture title
                    echo 'title_' | append: i
                  endcapture
                  capture image
                    echo 'image_' | append: i
                  endcapture
                %}
                {% if block.settings[image] and block.settings[title] != blank %}
                  {% assign do_images_exist = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
          
        {% endfor %}



          {%- if link.links != blank or has_mega_image and do_images_exist -%}
            <span class="expand-icon-container"
              ><span class="expand-icon-container-wrapper">
                {%- render 'header-icons', name: 'down' -%}
                {% comment %}
                  {%- render 'all-icons', name: 'plus' -%}
                  {%- render 'all-icons', name: 'minus' -%}
                {% endcomment %}
              </span></span
            >
          {%- endif %}
          
        </div>
        {% if link.links != blank %}
          <ul class="child-m">
            {% for child_link in link.links %}
              <li
                {% if child_link.active %}
                  class="active {% if child_link.child_active %}child-active{% endif %}"
                {% endif %}
              >
                <div class="has-double-sub-menu">
                  <a href="{{ child_link.url }}">{{ child_link.title }}</a>
                  {%- if child_link.links != blank -%}
                    <span class="expand-icon-container"
                      ><span class="expand-icon-container-wrapper">
                        {%- render 'header-icons', name: 'down' -%}
                        {% comment %}
                          {%- render 'all-icons', name: 'plus' -%}
                          {%- render 'all-icons', name: 'minus' -%}
                        {% endcomment %}
                      </span></span
                    >
                  {%- endif %}
                </div>
                {% if child_link.links != blank %}
                  <ul class="grandchild-m">
                    {% for grandchild_link in child_link.links %}
                      <li
                        {% if grandchild_link.active %}
                          class="active {% if grandchild_link.child_active %}child-active{% endif %}"
                        {% endif %}
                      >
                        <a href="{{ grandchild_link.url }}">{{ grandchild_link.title }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
            <li class="grand__parent-sm">
              <a href="{{ link.url }}">SHOP ALL {{ link.title }}</a>
            </li>

            {% liquid
              assign title_handle = link.title | handleize
              assign has_mega_item = false
            %}
            {% for block in section.blocks %}
              {% if block.type == 'mega-menu' %}
                {% liquid
                  assign menu_title = block.settings.heading | handleize

                  if menu_title == blank or menu_title != title_handle
                    continue
                  endif

                  if menu_title == title_handle
                    assign has_mega_item = true
                  endif
                %}
                {% assign has_images = false %}
                {% if has_mega_item == true %}
                  {% for i in (1..5) %}
                    {% liquid
                      capture collection
                        echo 'collection_' | append: i
                      endcapture
                    %}
                    {% if block.settings[collection] != blank %}
                      {% assign has_images = true %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endif %}
              
            {% endfor %}

              {% if has_mega_item %}
                {% render 'megamenu-images-sm',
                  section: section,
                  link: link,
                  has_mega_item: has_mega_item,
                  has_images: has_images
                %}
              {% endif %}
              

               {% liquid
                  assign title_handle = link.title | handleize
                  assign has_mega_item = false
                %}
                {% for block in section.blocks %}
                  {% liquid
                    assign menu_title = block.settings.heading | handleize
            
                    if menu_title == blank or menu_title != title_handle
                      continue
                    endif
            
                    if menu_title == title_handle
                      assign has_mega_item = true
                    endif
                  %}
               {% endfor %}
              {% if has_mega_item %}
                  {% liquid
                    assign title_handle = link.title | handleize
                    assign has_bottom_bar = false
                    assign has_mega_item = false
                  %}
                  {% for block in section.blocks %}
                    {% liquid
                      assign menu_title = block.settings.heading | handleize
                      if menu_title == blank or menu_title != title_handle
                        continue
                      endif
                    %}
                    {% if menu_title == title_handle %}
                      {% for i in (1..7) %}
                        {% liquid
                          capture title
                            echo 'title_' | append: i
                          endcapture
                          capture link
                            echo 'link_' | append: i
                          endcapture
                          if block.settings[title] != blank
                            assign has_bottom_bar = true
                          endif
                        %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% if has_bottom_bar %}
                    <div class="mega__menu-bottom-bar {{ has_bottom_bar }} {{ has_mega_item }}">
                      <div class="mega__menu-bottom-bar-wrapper ">
                        {% for block in section.blocks %}
                          {% liquid
                            assign menu_title = block.settings.heading | handleize
                            if menu_title == blank or menu_title != title_handle
                              continue
                            endif
                          %}
                          {% if menu_title == title_handle %}
                            {% for i in (1..7) %}
                              {% liquid
                                capture title
                                  echo 'title_' | append: i
                                endcapture
                                capture link
                                  echo 'link_' | append: i
                                endcapture
                              %}
                              {% if block.settings[title] != blank %}
                                <a href="{{ block.settings[link] | default: '#' }}"><span>{{ block.settings[title] }}</span></a>
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
              {% endif %}
          </ul>
        {% endif %}


        {% liquid
          assign title_handle = link.title | handleize
          assign has_mega_image = false
        %}
        {% for block in section.blocks %}

          {% if block.type == 'image_mega_menu' %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif

              if menu_title == title_handle
                assign has_mega_image = true
              endif
            %}
            {% assign do_images_exist = false %}
            {% if has_mega_image == true %}
              {% for i in (1..4) %}
                {% liquid
                  capture title
                    echo 'title_' | append: i
                  endcapture
                  capture image
                    echo 'image_' | append: i
                  endcapture
                %}
                {% if block.settings[image] and block.settings[title] != blank %}
                  {% assign do_images_exist = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
          
        {% endfor %}
          
        {% if has_mega_image and do_images_exist %}
          {% render 'images-mega-menu-sm', section: section, link: link, has_mega_image: has_mega_image, do_images_exist: do_images_exist %}
        {% endif %}

        
      </li>
    {%- endfor -%}
  </ul>
</nav>
