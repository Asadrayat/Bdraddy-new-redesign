<ul class="site__nav-wrapper">
  {% for link in section.settings.menu.links limit: first_part_size %}
    {% liquid
      assign title_handle = link.title | handleize
      assign has_mega_item = false
    %}
    {% for block in section.blocks %}
      {% if block.type == 'mega-menu' %}
        {% liquid
          assign menu_title = block.settings.heading | handleize

          if menu_title == blank or menu_title != title_handle
            continue
          endif

          if menu_title == title_handle
            assign has_mega_item = true
          endif
        %}
      {% endif %}
    {% endfor %}
    <li class="{% if link.title == 'SPORT' %}sport-link{% endif %} {% if has_mega_item %}mega__menu-li{% endif %}">
      {% if link.links != blank %}
        <a {% if has_mega_item %}class="item__mega-link"{% endif %} href="{{ link.url }}">
          <span class="lvl1_item">
            <span class="lvl1_item_text">{{- link.title -}}</span>
            <span class="lvl1_item_icon">{%- render 'header-icons', name: 'down' -%}</span>
          </span>
        </a>
        {% liquid
          assign title_handle = link.title | handleize
          assign has_mega_item = false
        %}
        {% for block in section.blocks %}
          {% if block.type == 'mega-menu' %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif

              if menu_title == title_handle
                assign has_mega_item = true
              endif
            %}
            {% assign has_images = false %}
            {% if has_mega_item == true %}
              {% for i in (1..5) %}
                {% liquid
                  capture collection
                    echo 'collection_' | append: i
                  endcapture
                %}
                {% if block.settings[collection] != blank %}
                  {% assign has_images = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if has_mega_item %}
          {% render 'mega-menu', section: section, link: link, has_mega_item: has_mega_item, has_images: has_images %}
        {% else %}
          {% render 'drop-down-menu', section: section, link: link %}
        {% endif %}
      {% else %}
        {% liquid
          assign title_handle = link.title | handleize
          assign has_mega_item = false
          assign has_mega_image = false
        %}
        {% for block in section.blocks %}

          {% if block.type == 'mega-menu' %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif

              if menu_title == title_handle
                assign has_mega_item = true
              endif
            %}
            {% assign has_images = false %}
            {% if has_mega_item == true %}
              {% for i in (1..5) %}
                {% liquid
                  capture collection
                    echo 'collection_' | append: i
                  endcapture
                %}
                {% if block.settings[collection] != blank %}
                  {% assign has_images = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}

          {% if block.type == 'image_mega_menu' %}
            {% liquid
              assign menu_title = block.settings.heading | handleize

              if menu_title == blank or menu_title != title_handle
                continue
              endif

              if menu_title == title_handle
                assign has_mega_image = true
              endif
            %}
            {% assign do_images_exist = false %}
            {% if has_mega_image == true %}
              {% for i in (1..4) %}
                {% liquid
                  capture title
                    echo 'title_' | append: i
                  endcapture
                  capture image
                    echo 'image_' | append: i
                  endcapture
                %}
                {% if block.settings[image] and block.settings[title] != blank %}
                  {% assign do_images_exist = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}

        {% endfor %}

        {% if has_mega_item and has_images %}
          <a href="{{ link.url }}">
            <span class="lvl1_item">
              <span class="lvl1_item_text">{{- link.title -}}</span>
              <span class="lvl1_item_icon">{%- render 'header-icons', name: 'down' -%}</span>
            </span>
          </a>
          {% render 'mega-menu', section: section, link: link, has_mega_item: has_mega_item, has_images: has_images %}
        {% elsif has_mega_image and do_images_exist %}
          <a href="{{ link.url }}">
            <span class="lvl1_item">
              <span class="lvl1_item_text">{{- link.title -}}</span>
              <span class="lvl1_item_icon">{%- render 'header-icons', name: 'down' -%}</span>
            </span>
          </a>
          {% render 'images-mega-menu', section: section, link: link, has_mega_image: has_mega_image, do_images_exist: do_images_exist %}
        {% else %}
          <a href="{{ link.url }}">{{ link.title }}</a>
        {% endif %}
      {% endif %}
    </li>
  {% endfor %}
</ul>
